___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "categories": ["ANALYTICS", "ADVERTISING"],
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Zbozi.cz Conversion",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Zbozi.cz standard conversion code\n@author House of Rezac\n@ web https://www.houseofrezac.com/gtm\n@version 2020-07-20",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "id",
    "displayName": "Shop ID",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "clearOnCopy": true,
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^[0-9]+$"
        ],
        "errorMessage": "Value must be numeric"
      },
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Shop ID from zbozi.cz"
  },
  {
    "type": "SELECT",
    "name": "orderId",
    "displayName": "Order ID",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "SELECT",
    "name": "debugMode",
    "displayName": "Debug Mode",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "help": "If enabled, sandbox will be used"
  },
  {
    "type": "SELECT",
    "name": "sandboxId",
    "displayName": "Sandbox Shop ID",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "help": "Value is used only in debug mode. If not set, real shop ID will be used",
    "enablingConditions": [
      {
        "paramName": "debugMode",
        "paramValue": "",
        "type": "PRESENT"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/**
 * https://github.com/seznam/zbozi-konverze
 */
const log = require('logToConsole');
const injectScript = require('injectScript');
const createQueue = require('createQueue');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');

log('Zbozi.cz', data);

  
setInWindow('ZboziConversionObject', 'zbozi');
setInWindow('zbozi', function() {    
  callInWindow('zbozi.q.push', arguments);
});
createQueue('zbozi.q');
setInWindow('zbozi.key', (data.debugMode && data.sandboxId) ? data.sandboxId : data.id);



let zbozi = copyFromWindow('zbozi');
if (data.debugMode) {
  zbozi("useSandbox");
}
zbozi('setOrder', {
  'orderId': data.orderId
});
zbozi("send");



const onSuccess = () => {
  log('Zbozi.cz: Script loaded successfully.');
  data.gtmOnSuccess();
};
const onFailure = () => {
  log('Zbozi.cz: Script load failed.');
  data.gtmOnFailure();
};
injectScript("https://www.zbozi.cz/conversion/js/conv-v3.js", onSuccess, onFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zbozi"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zbozi.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zbozi.key"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zbozi.q.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ZboziConversionObject"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.zbozi.cz/conversion/js/conv-v3.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Script Was Injected
  code: |-
    const mockData = validData;
    runCode(mockData);
    assertApi('injectScript').wasCalled();
setup: |-
  const validData = {
    'id': 1111,
    'orderId': 'T123',
    'debugMode': false
  };


___NOTES___

Created on 9. 3. 2020 21:56:52


